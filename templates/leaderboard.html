{% extends "base.html" %}

{% block title %}Leaderboard - TTS Arena{% endblock %}

{% block current_page %}Leaderboard{% endblock %}

{% block extra_head %}
<style>
    .leaderboard-container {
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        width: 100%;
        overflow-x: auto; /* Allow horizontal scrolling on small screens */
    }

    .leaderboard-header {
        display: grid;
        grid-template-columns: 80px 1fr 120px 120px 120px;
        padding: 16px;
        background-color: var(--light-gray);
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
        min-width: 600px; /* Ensure minimum width for the grid */
    }

    .leaderboard-row {
        display: grid;
        grid-template-columns: 80px 1fr 120px 120px 120px;
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        align-items: center;
        min-width: 600px; /* Ensure minimum width for the grid */
    }

    .leaderboard-row:last-child {
        border-bottom: none;
    }

    .rank {
        font-weight: 600;
        color: var(--primary-color);
    }

    .model-name {
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .model-name-link {
        text-decoration: none;
        color: var(--text-color);
    }

    .model-name-link:hover {
        text-decoration: underline;
    }
    
    .license-icon {
        width: 12px;
        height: 12px;
        cursor: help;
        position: relative;
        opacity: 0.7;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .license-icon img {
        width: 12px;
        height: 12px;
        vertical-align: middle;
    }
    
    .tooltip {
        visibility: hidden;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        text-align: center;
        border-radius: 4px;
        padding: 5px 10px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-weight: normal;
        font-size: 12px;
        white-space: nowrap;
    }
    
    .license-icon:hover .tooltip {
        visibility: visible;
        opacity: 1;
    }

    .win-rate, .total-votes, .elo-score {
        text-align: right;
        color: #666;
    }
    
    .elo-score {
        font-weight: 600;
    }
    
    .tier-s {
        background-color: rgba(255, 215, 0, 0.1);
    }
    
    .tier-a {
        background-color: rgba(80, 200, 120, 0.1);
    }
    
    .tier-b {
        background-color: rgba(80, 70, 229, 0.1);
    }
    
    .filter-controls {
        display: flex;
        margin-bottom: 24px;
        align-items: center;
        gap: 16px;
    }
    
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 24px;
    }

    .tab {
        padding: 12px 24px;
        cursor: pointer;
        position: relative;
        font-weight: 500;
    }

    .tab.active {
        color: var(--primary-color);
    }

    .tab.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: var(--primary-color);
    }

    .coming-soon {
        text-align: center;
        padding: 60px 0;
        color: #666;
        font-size: 18px;
        font-weight: 500;
    }
    
    .no-data {
        text-align: center;
        padding: 40px 0;
        color: #666;
    }
    
    .no-data h3 {
        margin-bottom: 12px;
        color: #333;
    }
    
    .no-data p {
        margin-bottom: 20px;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .view-toggle {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 20px;
    }
    
    .segmented-control {
        position: relative;
        display: inline-flex;
        background-color: var(--light-gray);
        border-radius: 8px;
        padding: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        -webkit-user-select: none;
        user-select: none;
    }
    
    .segmented-control input[type="radio"] {
        display: none;
    }
    
    .segmented-control label {
        position: relative;
        z-index: 2;
        padding: 8px 20px;
        font-size: 14px;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
        transition: color 0.2s ease;
        color: #666;
        border-radius: 6px;
    }
    
    .segmented-control label:hover {
        color: #333;
    }
    
    .segmented-control input[type="radio"]:checked + label {
        color: #fff;
    }
    
    .slider {
        position: absolute;
        z-index: 1;
        top: 4px;
        left: 4px;
        height: calc(100% - 8px);
        border-radius: 6px;
        transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        background-color: var(--primary-color);
    }
    
    .login-prompt {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    
    .login-prompt-content {
        background-color: var(--light-gray);
        padding: 24px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        text-align: center;
        max-width: 400px;
        position: relative;
    }
    
    .login-prompt-content h3 {
        margin-bottom: 16px;
    }
    
    .login-prompt-content p {
        margin-bottom: 24px;
    }
    
    .login-prompt-close {
        position: absolute;
        top: 12px;
        right: 12px;
        font-size: 20px;
        cursor: pointer;
        color: #999;
    }
    
    .btn {
        display: inline-block;
        background-color: var(--primary-color);
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        text-decoration: none;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .leaderboard-header, .leaderboard-row {
            grid-template-columns: 60px 1fr 80px 80px;
            min-width: 400px; /* Reduced minimum width for mobile */
        }

        .total-votes {
            display: none;
        }

        .leaderboard-header .total-votes-header {
            display: none;
        }
        
        .filter-controls {
            flex-direction: column;
            align-items: flex-start;
        }
    }

    @media (max-width: 480px) {
        .leaderboard-header, .leaderboard-row {
            grid-template-columns: 50px 1fr 70px;
            min-width: 300px; /* Further reduced for very small screens */
            font-size: 14px;
            padding: 12px 8px;
        }

        .elo-score {
            font-size: 14px;
        }

        .total-votes, .win-rate {
            display: none;
        }

        .leaderboard-header .total-votes-header,
        .leaderboard-header div:nth-child(3) {
            display: none;
        }

        .tab {
            padding: 10px 16px;
            font-size: 14px;
        }
    }

    /* Dark mode styles */
    @media (prefers-color-scheme: dark) {
        .no-data {
            color: var(--text-color);
        }

        .no-data h3 {
            color: var(--text-color);
        }
        
        
        .leaderboard-container {
            background-color: var(--light-gray);
            border-color: var(--border-color);
        }
        
        .leaderboard-header {
            background-color: rgba(80, 70, 229, 0.1);
            border-color: var(--border-color);
        }
        
        .leaderboard-row {
            border-color: var(--border-color);
        }
        
        .leaderboard-row:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .tier-s {
            background-color: rgba(255, 215, 0, 0.1);
        }
        
        .tier-a {
            background-color: rgba(192, 192, 192, 0.1);
        }
        
        .tier-b {
            background-color: rgba(205, 127, 50, 0.1);
        }
        
        .segmented-control {
            background-color: var(--light-gray);
            border-color: var(--border-color);
        }
        
        .segmented-control label {
            color: var(--text-color);
        }

        .segmented-control label:hover {
            color: var(--text-color);
        }
        
        .segmented-control .slider {
            background-color: var(--primary-color);
        }
        
        .tooltip {
            background-color: var(--light-gray);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        .license-icon img {
            filter: invert(1);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="tabs">
    <div class="tab active" data-tab="tts">TTS</div>
    <div class="tab" data-tab="conversational">Conversational</div>
</div>

<div id="tts-tab" class="tab-content">
    <div class="view-toggle">
        <div class="segmented-control">
            <input type="radio" id="tts-public" name="tts-view" checked>
            <label for="tts-public">Public</label>
            <input type="radio" id="tts-personal" name="tts-view">
            <label for="tts-personal">Personal</label>
            <div class="slider"></div>
        </div>
    </div>

    <div id="tts-public-leaderboard" class="leaderboard-view active">
        {% if tts_leaderboard and tts_leaderboard|length > 0 %}
        <div class="leaderboard-container">
            <div class="leaderboard-header">
                <div>Rank</div>
                <div>Model</div>
                <div style="text-align: right">Win Rate</div>
                <div style="text-align: right" class="total-votes-header">Total Votes</div>
                <div style="text-align: right">ELO</div>
            </div>
            
            {% for model in tts_leaderboard %}
            <div class="leaderboard-row {{ model.tier }}">
                <div class="rank">#{{ model.rank }}</div>
                <div class="model-name">
                    <a href="{{ model.model_url }}" target="_blank" class="model-name-link">{{ model.name }}</a>
                    <div class="license-icon">
                        {% if model.is_open %}
                        <img src="{{ url_for('static', filename='open.svg') }}" alt="Open">
                        <span class="tooltip">Open model</span>
                        {% else %}
                        <img src="{{ url_for('static', filename='closed.svg') }}" alt="Proprietary">
                        <span class="tooltip">Proprietary model</span>
                        {% endif %}
                    </div>
                </div>
                <div class="win-rate">{{ model.win_rate }}</div>
                <div class="total-votes">{{ model.total_votes }}</div>
                <div class="elo-score">{{ model.elo }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-data">
            <h3>No data available yet</h3>
            <p>Be the first to vote and help build the leaderboard! Compare models in the arena to see how they stack up.</p>
            <a href="{{ url_for('arena') }}" class="btn">Go to Arena</a>
        </div>
        {% endif %}
    </div>
    
    <div id="tts-personal-leaderboard" class="leaderboard-view" style="display: none;">
        {% if current_user.is_authenticated and tts_personal_leaderboard and tts_personal_leaderboard|length > 0 %}
        <div class="leaderboard-container">
            <div class="leaderboard-header">
                <div>Rank</div>
                <div>Model</div>
                <div style="text-align: right">Win Rate</div>
                <div style="text-align: right" class="total-votes-header">Total Votes</div>
                <div style="text-align: right">Wins</div>
            </div>
            
            {% for model in tts_personal_leaderboard %}
            <div class="leaderboard-row">
                <div class="rank">#{{ model.rank }}</div>
                <div class="model-name">
                    <a href="{{ model.model_url }}" target="_blank" class="model-name-link">{{ model.name }}</a>
                    <div class="license-icon">
                        {% if model.is_open %}
                        <img src="{{ url_for('static', filename='open.svg') }}" alt="Open">
                        <span class="tooltip">Open model</span>
                        {% else %}
                        <img src="{{ url_for('static', filename='closed.svg') }}" alt="Proprietary">
                        <span class="tooltip">Proprietary model</span>
                        {% endif %}
                    </div>
                </div>
                <div class="win-rate">{{ model.win_rate }}</div>
                <div class="total-votes">{{ model.total_votes }}</div>
                <div class="elo-score">{{ model.wins }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-data">
            <h3>No personal data yet</h3>
            <p>You haven't voted on any TTS models yet. Visit the arena to compare models and build your personal leaderboard.</p>
            <a href="{{ url_for('arena') }}" class="btn">Go to Arena</a>
        </div>
        {% endif %}
    </div>
</div>

<div id="conversational-tab" class="tab-content" style="display: none;">
    <div class="view-toggle">
        <div class="segmented-control">
            <input type="radio" id="conversational-public" name="conversational-view" checked>
            <label for="conversational-public">Public</label>
            <input type="radio" id="conversational-personal" name="conversational-view">
            <label for="conversational-personal">Personal</label>
            <div class="slider"></div>
        </div>
    </div>

    <div id="conversational-public-leaderboard" class="leaderboard-view active">
        {% if conversational_leaderboard and conversational_leaderboard|length > 0 %}
        <div class="leaderboard-container">
            <div class="leaderboard-header">
                <div>Rank</div>
                <div>Model</div>
                <div style="text-align: right">Win Rate</div>
                <div style="text-align: right" class="total-votes-header">Total Votes</div>
                <div style="text-align: right">ELO</div>
            </div>
            
            {% for model in conversational_leaderboard %}
            <div class="leaderboard-row {{ model.tier }}">
                <div class="rank">#{{ model.rank }}</div>
                <div class="model-name">
                    {{ model.name }}
                    <div class="license-icon">
                        {% if model.is_open %}
                        <img src="{{ url_for('static', filename='open.svg') }}" alt="Open">
                        <span class="tooltip">Open model</span>
                        {% else %}
                        <img src="{{ url_for('static', filename='closed.svg') }}" alt="Proprietary">
                        <span class="tooltip">Proprietary model</span>
                        {% endif %}
                    </div>
                </div>
                <div class="win-rate">{{ model.win_rate }}</div>
                <div class="total-votes">{{ model.total_votes }}</div>
                <div class="elo-score">{{ model.elo }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-data">
            <h3>No data available yet</h3>
            <p>Be the first to vote and help build the conversational leaderboard! Compare models in the arena to see how they stack up.</p>
            <a href="{{ url_for('arena') }}#conversational" class="btn">Go to Arena</a>
        </div>
        {% endif %}
    </div>
    
    <div id="conversational-personal-leaderboard" class="leaderboard-view" style="display: none;">
        {% if current_user.is_authenticated and conversational_personal_leaderboard and conversational_personal_leaderboard|length > 0 %}
        <div class="leaderboard-container">
            <div class="leaderboard-header">
                <div>Rank</div>
                <div>Model</div>
                <div style="text-align: right">Win Rate</div>
                <div style="text-align: right" class="total-votes-header">Total Votes</div>
                <div style="text-align: right">Wins</div>
            </div>
            
            {% for model in conversational_personal_leaderboard %}
            <div class="leaderboard-row">
                <div class="rank">#{{ model.rank }}</div>
                <div class="model-name">
                    {{ model.name }}
                    <div class="license-icon">
                        {% if model.is_open %}
                        <img src="{{ url_for('static', filename='open.svg') }}" alt="Open">
                        <span class="tooltip">Open model</span>
                        {% else %}
                        <img src="{{ url_for('static', filename='closed.svg') }}" alt="Proprietary">
                        <span class="tooltip">Proprietary model</span>
                        {% endif %}
                    </div>
                </div>
                <div class="win-rate">{{ model.win_rate }}</div>
                <div class="total-votes">{{ model.total_votes }}</div>
                <div class="elo-score">{{ model.wins }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-data">
            <h3>No personal data yet</h3>
            <p>You haven't voted on any conversational models yet. Visit the arena to compare models and build your personal leaderboard.</p>
            <a href="{{ url_for('arena') }}#conversational" class="btn">Go to Arena</a>
        </div>
        {% endif %}
    </div>
</div>

<div class="login-prompt">
    <div class="login-prompt-content">
        <div class="login-prompt-close">&times;</div>
        <h3>Login Required</h3>
        <p>You need to be logged in to view your personal leaderboard.</p>
        <a href="{{ url_for('auth.login', next=request.path) }}" class="btn">Login with Hugging Face</a>
    </div>
</div>

<!-- Pass auth status via data attribute -->
<div id="auth-data" data-is-logged-in="{% if current_user.is_authenticated %}true{% else %}false{% endif %}"></div>

<script>
    // Set auth status from server-side
    var isLoggedIn = document.getElementById('auth-data').dataset.isLoggedIn === 'true';
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize slider positions
        const ttsSlider = document.querySelector('#tts-tab .slider');
        const convSlider = document.querySelector('#conversational-tab .slider');
        
        // Function to position sliders based on selected radio
        function positionSliders() {
            // Position TTS slider
            if (ttsSlider) {
                const ttsSelectedRadio = document.querySelector('#tts-tab input[name="tts-view"]:checked');
                if (ttsSelectedRadio) {
                    const ttsSelectedLabel = document.querySelector(`label[for="${ttsSelectedRadio.id}"]`);
                    ttsSlider.style.width = `${ttsSelectedLabel.offsetWidth}px`;
                    ttsSlider.style.transform = `translateX(${ttsSelectedLabel.offsetLeft - 4}px)`;
                }
            }
            
            // Position Conversational slider
            if (convSlider) {
                const convSelectedRadio = document.querySelector('#conversational-tab input[name="conversational-view"]:checked');
                if (convSelectedRadio) {
                    const convSelectedLabel = document.querySelector(`label[for="${convSelectedRadio.id}"]`);
                    convSlider.style.width = `${convSelectedLabel.offsetWidth}px`;
                    convSlider.style.transform = `translateX(${convSelectedLabel.offsetLeft - 4}px)`;
                }
            }
        }
        
        // Position sliders on load
        positionSliders();
        
        // Tab switching
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Check URL hash for direct tab access
        function checkHashAndSetTab() {
            const hash = window.location.hash.toLowerCase();
            if (hash === '#conversational') {
                // Switch to conversational tab
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.style.display = 'none');
                
                document.querySelector('.tab[data-tab="conversational"]').classList.add('active');
                document.getElementById('conversational-tab').style.display = 'block';
                
                // Ensure sliders are positioned correctly
                setTimeout(positionSliders, 50);
            } else if (hash === '#tts' || hash === '') {
                // Switch to TTS tab (default)
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.style.display = 'none');
                
                document.querySelector('.tab[data-tab="tts"]').classList.add('active');
                document.getElementById('tts-tab').style.display = 'block';
                
                // Ensure sliders are positioned correctly
                setTimeout(positionSliders, 50);
            }
        }
        
        // Check hash on page load
        checkHashAndSetTab();
        
        // Listen for hash changes
        window.addEventListener('hashchange', checkHashAndSetTab);
        
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                
                // Update URL hash without page reload
                history.replaceState(null, null, `#${tabId}`);
                
                // Remove active class from all tabs and hide all contents
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.style.display = 'none');
                
                // Add active class to clicked tab and show corresponding content
                this.classList.add('active');
                document.getElementById(tabId + '-tab').style.display = 'block';
                
                // Position sliders after tab switch
                setTimeout(positionSliders, 0);
            });
        });
        
        // View toggle functionality
        const viewToggles = document.querySelectorAll('.segmented-control input[type="radio"]');
        const loginPrompt = document.querySelector('.login-prompt');
        const loginPromptClose = document.querySelector('.login-prompt-close');
        
        viewToggles.forEach(toggle => {
            toggle.addEventListener('change', function() {
                const view = this.id.split('-')[1]; // 'public' or 'personal'
                const tabId = this.closest('.tab-content').id.split('-')[0]; // 'tts' or 'conversational'
                
                if (view === 'personal' && !isLoggedIn) {
                    // Show login prompt
                    loginPrompt.style.display = 'flex';
                    // Reset the radio button to public
                    document.getElementById(`${tabId}-public`).checked = true;
                    return;
                }
                
                // Position the slider using our function
                positionSliders();
                
                // Show corresponding leaderboard
                const leaderboardViews = document.querySelectorAll(`#${tabId}-tab .leaderboard-view`);
                leaderboardViews.forEach(v => {
                    v.style.display = 'none';
                    v.classList.remove('active');
                });
                const activeView = document.getElementById(`${tabId}-${view}-leaderboard`);
                activeView.style.display = 'block';
                activeView.classList.add('active');
            });
        });
        
        // Close login prompt
        if (loginPromptClose) {
            loginPromptClose.addEventListener('click', function() {
                loginPrompt.style.display = 'none';
            });
        }
        
        // Final positioning after all DOM operations are complete
        setTimeout(positionSliders, 100);
        
        // Reposition sliders on window resize
        window.addEventListener('resize', function() {
            positionSliders();
        });
    });
</script>
{% endblock %} 